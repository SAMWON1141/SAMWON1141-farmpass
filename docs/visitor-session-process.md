# 방문자 쿠키 및 세션 토큰 관리 프로세스

## 1. 목적

- 방문자 등록 시 **자동완성(UX)** 및 **재방문 제한(정책)** 기능을 제공하기 위해 쿠키(`visitor_session`)와 DB 세션 토큰(`session_token`)을 함께 관리한다.

---

## 2. 주요 용어

- **visitor_session 쿠키**:  
  방문자 브라우저에 저장되는 세션 토큰.  
  자동완성 및 재방문 제한 체크에 사용.  
  만료시간은 30일로 고정.

- **session_token (DB)**:  
  방문자 등록 시마다 생성되는 UUID.  
  방문 기록(`visitor_entries`)에 저장.  
  재방문 제한 체크의 기준이 됨.

---

## 3. 전체 프로세스

### 3.1 방문자 등록(폼 제출)

1. 사용자가 방문자 등록 폼을 제출하면 서버에서 새로운 `session_token`(UUID) 생성
2. 이 토큰을 **DB(방문 기록)**에 저장
3. 동시에 **visitor_session 쿠키**를 30일 만료로 브라우저에 발급  
   (쿠키 옵션: `httpOnly: false`, `secure: true(운영)/false(개발)`, `sameSite: lax`)
4. 이후 방문 시 자동완성 및 재방문 제한 체크에 사용

---

### 3.2 방문 폼 접속

1. 클라이언트는 `/api/farms/[farmId]/visitors/check-session` API를 호출
2. 서버는 쿠키(`visitor_session`)가 있으면 DB에서 해당 토큰의 최근 방문 기록을 조회
3. 정책(`reVisitAllowInterval`)에 따라
   - **재방문 제한 중**: 남은 시간 안내(에러 메시지)
   - **제한 해제**: 자동완성 정보 제공, 남은 시간 0
4. 쿠키가 없으면(만료/삭제): "첫 방문"으로 간주, 자동완성 불가

---

### 3.3 재방문 제한 체크

- 폼 제출 시에도 쿠키의 세션토큰으로 DB에서 최근 방문 기록을 조회
- 정책상 제한시간이 남아있으면 등록 거부(에러)
- 제한시간이 지났으면 등록 허용, 새 토큰 발급 및 쿠키 갱신

---

### 3.4 쿠키 만료 및 삭제

- **브라우저가 30일이 지나면 쿠키를 자동 삭제**  
  (expires 속성에 따라 자동 정리)
- 쿠키가 없으면 "첫 방문"처럼 동작, DB에는 예전 기록이 남아있음

---

### 3.5 DB의 세션토큰 관리

- 방문 이력(로그)로만 남아 있음
- 쿠키가 없으면 이 기록은 재방문 제한/자동완성에 사용되지 않음
- 개인정보 보호를 위해 3년 후 자동 삭제 등 데이터 보존 정책 적용 가능

---

## 4. 예외 및 특이 상황

- **정책 변경(예: 0일→3시간)**:  
  기존 쿠키/DB 기록이 있어도, 정책 변경 즉시 새로운 정책이 적용됨  
  (쿠키가 남아있어도 DB의 방문 기록과 정책 기준으로 제한 체크)
- **쿠키가 손상/삭제된 경우**:  
  "첫 방문"으로 간주, 자동완성/재방문 제한 모두 해제
- **다중 브라우저/기기**:  
  각 브라우저/기기마다 별도의 쿠키와 session_token이 발급됨

---

## 5. 보안 및 개인정보 보호

- 쿠키 옵션은 보안과 UX를 모두 고려하여 설정
- DB의 방문 기록은 개인정보로 간주, 보존 기간 정책을 명확히 함
- 쿠키 만료, DB 자동 삭제 등으로 개인정보 보호 강화

---

## 6. 요약

- **쿠키**: 30일간 자동완성 및 재방문 제한 체크에 사용, 만료 시 자동 삭제
- **DB 세션토큰**: 방문 이력 관리, 정책 기준 재방문 제한 체크
- **정책 변경/쿠키 만료/삭제**: 시스템이 자동으로 일관성 있게 처리

---

> 이 문서는 방문자 쿠키/세션토큰 관리의 전체 흐름을 실무자, 관리자, 유지보수 담당자가 쉽게 이해할 수 있도록 작성되었습니다.
